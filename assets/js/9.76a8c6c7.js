(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{577:function(t,s,a){t.exports=a.p+"assets/img/distance.83195985.png"},578:function(t,s,a){t.exports=a.p+"assets/img/rollup01.83891f59.png"},579:function(t,s,a){t.exports=a.p+"assets/img/rollup02.c1740d24.png"},622:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h3",{attrs:{id:"_1-提升用户的开发体验"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-提升用户的开发体验"}},[t._v("#")]),t._v(" 1. 提升用户的开发体验")]),t._v(" "),n("ol",[n("li",[t._v("提供良好的报错信息，"),n("code",[t._v("Vue")]),t._v("通过"),n("code",[t._v("warn")]),t._v("函数尽可能的提供了良好的报错提示信息。")]),t._v(" "),n("li",[n("code",[t._v("Vue")]),t._v("通过"),n("code",[t._v("initCustomFormatter")]),t._v("函数来提供了自定义输出，在谷歌浏览器中通过勾选"),n("code",[t._v("Enable custom formatters")]),t._v("可以调用该函数，让我们的输出更为直观。以下是开启这个功能前后的输出差异。\n"),n("img",{attrs:{src:a(577),alt:""}})])]),t._v(" "),n("h3",{attrs:{id:"_2-控制框架代码的体积"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-控制框架代码的体积"}},[t._v("#")]),t._v(" 2. 控制框架代码的体积")]),t._v(" "),n("p",[t._v("我们都知道一个常识，当一个框架提供的报错信息越详细时，其对应的代码就会越臃肿。最后浏览器加载资源所用的时间也就越长。"),n("code",[t._v("Vue")]),t._v("通过"),n("code",[t._v("__DEV__")]),t._v("这个常量来配合"),n("code",[t._v("warn")]),t._v("函数控制报错信息的输出。当是开发环境时，该常量为"),n("code",[t._v("true")]),t._v("，报错能正常输出。当构建生产环境的资源时，该常量会被设置为"),n("code",[t._v("false")]),t._v("，然后其内部的报错信息因为永远不可能执行而变成了"),n("code",[t._v("dead code")]),t._v(" ，在构建时这些代码就会被移除。因此在"),n("code",[t._v("vue.global.prod.js")]),t._v("中是不存在这段代码对的。通过这种设置"),n("code",[t._v("Vue")]),t._v("就做到了"),n("strong",[t._v("在开发环境中为用户提供友好的警告信息的同时，不会增加生产环境代码的体积")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__DEV__ "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("warn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxxxxx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"_3-框架要做到良好的-tree-shaking"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-框架要做到良好的-tree-shaking"}},[t._v("#")]),t._v(" 3. 框架要做到良好的 Tree-Shaking")]),t._v(" "),n("h4",{attrs:{id:"_3-1-什么是-tree-shaking"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-什么是-tree-shaking"}},[t._v("#")]),t._v(" 3.1 什么是 Tree-shaking?")]),t._v(" "),n("p",[t._v("简单的说，"),n("code",[t._v("Tree-Shaking")]),t._v("指的就是消除永远不会被执行的代码，也就是排除"),n("code",[t._v("dead code")]),t._v("，无论是"),n("code",[t._v("rollup")]),t._v("还是"),n("code",[t._v("webpack")]),t._v("均支持"),n("code",[t._v("Tree-Shaking")]),t._v("。")]),t._v(" "),n("h4",{attrs:{id:"_3-2-使用-tree-shaking-的两个关键点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-使用-tree-shaking-的两个关键点"}},[t._v("#")]),t._v(" 3.2 使用 Tree-Shaking 的两个关键点")]),t._v(" "),n("ol",[n("li",[t._v("由于"),n("code",[t._v("Tree-Shaking")]),t._v("依赖"),n("code",[t._v("ESM")]),t._v("的静态结构，所以模块必须使用"),n("code",[t._v("ESM")]),t._v("；想要了解什么是"),n("code",[t._v("ESM")]),t._v("，推荐阮一峰大佬的教程"),n("a",{attrs:{href:"https://wangdoc.com/es6/module",target:"_blank",rel:"noopener noreferrer"}},[t._v("Module 语法"),n("OutboundLink")],1),t._v("。")]),t._v(" "),n("li",[t._v("如果一个函数调用会产生副作用，那么就不能将其移除。\n"),n("ul",[n("li",[t._v("什么是副作用？ 简单来说，就是函数调用时侯会对外部生产影响，比如修改了某个全局变量的值。")])])])]),t._v(" "),n("p",[t._v("下边我们来看两个 demo")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("demo1 的目录结构以及各个文件的内容如下图，注意在"),n("code",[t._v("input.js")]),t._v("中我们只引入了"),n("code",[t._v("foo")]),t._v("函数，没有用到"),n("code",[t._v("bar")]),t._v("函数。\n"),n("img",{attrs:{src:a(578),alt:"demo1"}}),t._v("\n当我们执行"),n("code",[t._v("yarn add rollup -D")]),t._v("（安装"),n("code",[t._v("rollup")]),t._v("） 和 "),n("code",[t._v("npx rollup input.js -f esm -o bundle.js")]),t._v("(以"),n("code",[t._v("input.js")]),t._v("左右入口，以"),n("code",[t._v("bundle.js")]),t._v("作为输出文件，输出的格式为"),n("code",[t._v("ESM")]),t._v(")命令后，可以看到在最后的"),n("code",[t._v("bundle.js")]),t._v("中只有"),n("code",[t._v("foo")]),t._v("函数，没有"),n("code",[t._v("bar")]),t._v("函数，所有"),n("code",[t._v("Tree-Shaking")]),t._v("起作用了。")])]),t._v(" "),n("li",[n("p",[t._v("demo2 的目录结构和 demo1 一样，仅仅是在"),n("code",[t._v("input.js")]),t._v("的文件中，给"),n("code",[t._v("foo")]),t._v("函数前边加上了"),n("code",[t._v("/*#_PURE_*/")]),t._v("标志，再次执行完打包命令后，可以看到输出的"),n("code",[t._v("bundle.js")]),t._v("文件为空文件了。\n"),n("img",{attrs:{src:a(579),alt:"demo1"}}),t._v(" "),n("code",[t._v("JavaScript")]),t._v("本身是动态语言，想要静态的分析哪些代码是"),n("code",[t._v("dead code")]),t._v("是非常困难的，于是"),n("code",[t._v("rollup")]),t._v("这类工具提供了一个标志"),n("code",[t._v("/*#_PURE_*/")]),t._v("，这个标志的作用就是，告诉"),n("code",[t._v("rollup.js")]),t._v("“后边这段代码，不会产生副作用，你可以放心的移除它”。")])])]),t._v(" "),n("p",[t._v("根据 JS 的特点我们可以知道，一般顶级调用（在全局作用域中直接调用，而不是在函数内部调用）中容易产生副作用，所以"),n("code",[t._v("Vue.js3")]),t._v("中在一些顶级调用的函数上会使用"),n("code",[t._v("/*#_PURE_*/")]),t._v("标志。")]),t._v(" "),n("p",[n("strong",[t._v("webpack、 terser 等工具均支持"),n("code",[t._v("/*#_PURE_*/")]),t._v("标志")])]),t._v(" "),n("h3",{attrs:{id:"_4-vue-js-输出的构建产物"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-vue-js-输出的构建产物"}},[t._v("#")]),t._v(" 4. Vue.js 输出的构建产物")]),t._v(" "),n("h4",{attrs:{id:"_4-1-通过-script-标签引入的-iife-格式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-通过-script-标签引入的-iife-格式"}},[t._v("#")]),t._v(" 4.1 通过"),n("code",[t._v("<script>")]),t._v("标签引入的 iife 格式")]),t._v(" "),n("p",[t._v("用户可以在 Html 中直接通过"),n("code",[t._v('<script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.41/vue.global.js"><\/script>')]),t._v("标签引入 Vue 框架并立即使用。为了满足用户的该需求，Vue.js 提供了"),n("code",[t._v("IIFE")]),t._v("（Immediately Invoked Function Expression）（立即调用函数表达式）格式的资源，其代码结构如下：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" Vue "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("exports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  exports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("createApp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" createApp\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" exports\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("在 rollup.js 中，我们可以通过"),n("code",[t._v("format:'iife'")]),t._v("来输出这种形式的资源")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("#rollup"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("js\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("input")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"input.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("output")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("file")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"output.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("format")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"iife"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h4",{attrs:{id:"_4-2-通过-script-type-module-标签引入的-esm-格式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-通过-script-type-module-标签引入的-esm-格式"}},[t._v("#")]),t._v(" 4.2 通过"),n("code",[t._v("<script type='module'>")]),t._v("标签引入的 esm 格式")]),t._v(" "),n("p",[t._v("浏览器发展至今，主流的浏览器都支持了 ESM。所以用户也可以直接通过"),n("code",[t._v('<script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.41/vue.esm-browser.js"><\/script>')]),t._v("标签进行引入 Vue 框架。")]),t._v(" "),n("p",[t._v("为了输出 ESM 格式的资源，"),n("code",[t._v("rollup.js")]),t._v("的配置项只需要修改"),n("code",[t._v("format:'esm'")]),t._v("即可。")]),t._v(" "),n("p",[n("code",[t._v("vue.esm-browser.js")]),t._v("中的"),n("code",[t._v("-browser")]),t._v("是为了用来表示这个格式的资源到底是给通过 script 标签直接引用的，"),n("code",[t._v("-bundler")]),t._v("表示是给构建工具使用的。无论"),n("code",[t._v("rollup.js")]),t._v("还是"),n("code",[t._v("webpack")]),t._v("，在寻找资源时，如果"),n("code",[t._v("package.json")]),t._v("中存在"),n("code",[t._v("module")]),t._v("字段，那么会优先使用"),n("code",[t._v("module")]),t._v("字段指向的资源来替代"),n("code",[t._v("main")]),t._v("字段指向的资源。在 Vue 的源码中的"),n("code",[t._v("packages/vue/packag.json")]),t._v("中有如下代码：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"main"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"index.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"module"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dist/vue.runtime.esm-bundler.js"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("在上文提到的"),n("code",[t._v("__DEV__")]),t._v("变量根据开发/生产环境会自动被设置为"),n("code",[t._v("true/false")]),t._v("，是存在于"),n("code",[t._v("-browser")]),t._v("资源中的，在"),n("code",[t._v("-bundler")]),t._v("资源中，使用的是"),n("code",[t._v("process.env.NODE_ENV !== 'PRODUCTION'")]),t._v(" 来替代该常量的。")]),t._v(" "),n("h4",{attrs:{id:"_4-3-在-node-js-中通过-require-引入的-cjs-格式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-在-node-js-中通过-require-引入的-cjs-格式"}},[t._v("#")]),t._v(" 4.3 在 Node.js 中通过 require 引入的 cjs 格式")]),t._v(" "),n("p",[t._v("为了满足服务端渲染的需求"),n("code",[t._v("Vue")]),t._v("提供了"),n("code",[t._v("cjs")]),t._v("模式的资源。"),n("code",[t._v("rollup.js")]),t._v("的配置项只需要修改"),n("code",[t._v("format:'cjs'")]),t._v("即可。")]),t._v(" "),n("h3",{attrs:{id:"_5-特性开关"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-特性开关"}},[t._v("#")]),t._v(" 5. 特性开关")]),t._v(" "),n("p",[t._v("在框架设计中，框架通常会提供很多特性/功能来共用户使用，比如提供了 A、B、C 三个功能，同时提供了 a、b、c 三个特性开关来控制这三个功能的启用与否。这样做有如下两点好处")]),t._v(" "),n("ul",[n("li",[t._v("对于用户关闭的特性，可以利用 Tree-Shaking 来去除代码，减少代码的最终体积，提升加载速度")]),t._v(" "),n("li",[t._v("让框架的设计变得更加的灵活，可以通过特性开关为框架添加新的特性。当框架升级时，特性开关可以用于让用户选择是否使用遗留的 API。")])]),t._v(" "),n("p",[t._v("特性开关的实现，其实还是利用的"),n("strong",[t._v("rollup.js 的预定义常量")]),t._v("来实现的。Vue3 的源码中有如下代码：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_FEATURE_OPTIONS_API_")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" isBundlerESMBuild "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("_VUE_OPTIONS_API_")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])])]),n("p",[t._v("其中的"),n("code",[t._v("_FEATURE_OPTIONS_API_")]),t._v("类是于"),n("code",[t._v("__DEV__")]),t._v("。在 Vue3 的源码中有很多类是于如下代码的分支判断：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// support for 2.x options")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_FEATURE_OPTIONS_API_"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  currentInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instance\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("pauseTraking")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("applyOptions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Component"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resetTraking")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  currentInstall "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("当 Vue 构建资源时，如果构建的是资源是共打包工具使用的"),n("code",[t._v("（带-bundler）")]),t._v("的，如上代码就会变为：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// support for 2.x options")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_VUE_OPTIONS_API_"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  currentInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instance\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("pauseTraking")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("applyOptions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Component"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resetTraking")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  currentInstall "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("其中，"),n("code",[t._v("_VUE_OPTIONS_API_")]),t._v("是一个特性开关（该特性开关是用来决定是否保留 vue2 的选项 API 模式还是完全采用 vue3 的"),n("code",[t._v("Composition API")]),t._v("模式），同常用户可以使用 webpack.DefinePlugin 插件来实现")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("webpack"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DefinePlugin")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_VUE_OPTIONS_API")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringfy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 开启特性")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h3",{attrs:{id:"_6-错误处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-错误处理"}},[t._v("#")]),t._v(" 6. 错误处理")]),t._v(" "),n("p",[t._v("Vue3.js 提供了"),n("code",[t._v("registerErrorHandler")]),t._v("函数，用户可以使用它注册错误处理程序，然后在"),n("code",[t._v("callWithErrorHanding")]),t._v("函数内部捕获错误后，把错误传递给用户注册的错误处理程序，让用户来灵活的处理报错。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" handleError "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("callWithErrorHandling")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户可以调用该函数注册统一的错误处理函数")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerErrorHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        handleError "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fn\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("callWithErrorHandling")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        fn "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将捕获到的错误传递给用户的错误处理程序")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleError")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("在Vue3.js中我们也可以注册统一的错误处理函数：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" App "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'App.vue'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createApp")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("App"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("errorHandler")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误处理程序")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);